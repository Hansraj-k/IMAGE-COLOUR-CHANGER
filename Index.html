<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remove Specific Color from Image</title>
    <style>
        #canvas {
            max-width: 100%;
            max-height: 500px;
            border: 1px solid black;
            margin-bottom: 20px;
        }
        #selectedColor {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 1px solid #000;
            display: inline-block;
            margin: 10px 0;
        }
        .color-inputs {
            margin: 10px 0;
        }
        #imageDimensions {
            margin: 10px 0;
            font-size: 14px;
        }
        #colorPaletteContainer {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: inline-block;
        }
        .color-picker-container {
            margin-top: 20px;
        }
        .color-picker-message {
            font-size: 14px;
            margin-top: 5px;
            color: #888;
        }
        #meaning {
            font-size: 14px;
            margin-top: 10px;
            color: #555;
        }
    </style>
</head>
<body>
    <input type="file" id="upload" accept="image/*">
    <div class="color-picker-container">
        <button id="eyeDropperBtn">ðŸ–¤ Pick Color (Desktop/Laptop)</button>
        <span class="color-picker-message">Works on Desktop/Laptop only</span>
        <input type="color" id="fallbackColorPicker" title="Pick Color (Mobile)" style="display:none;">
    </div>
    <div id="selectedColor" style="background-color: #ffffff;"></div>
    <div class="color-inputs">
        <label for="hexInput">Hex Code:</label>
        <input type="text" id="hexInput" value="#ffffff">
    </div>
    <div class="color-inputs">
        <label for="rgbInput">RGB:</label>
        <input type="text" id="rgbInput" value="rgb(255, 255, 255)">
    </div>
    <div id="imageDimensions">Dimensions: Not uploaded yet</div>
    <button onclick="removeColor()">Remove Color</button>
    <button onclick="downloadImage()">Download Image</button>
    <canvas id="canvas"></canvas>
    <div id="meaning">Select a color from the image or use the color picker to remove it from the image.</div>
    <div id="colorPaletteContainer"></div>

    <script>
        const upload = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const eyeDropperBtn = document.getElementById('eyeDropperBtn');
        const fallbackColorPicker = document.getElementById('fallbackColorPicker');
        const hexInput = document.getElementById('hexInput');
        const rgbInput = document.getElementById('rgbInput');
        const selectedColorDiv = document.getElementById('selectedColor');
        const imageDimensions = document.getElementById('imageDimensions');
        const colorPaletteContainer = document.getElementById('colorPaletteContainer');
        const meaningText = document.getElementById('meaning');

        let img = new Image();
        let selectedColor = '#ffffff';
        let originalImgData;
        let originalImageSrc;
        let originalImageName = "image"; // Default name for the image
        let colorCounts = {}; // Object to store frequency of each color

        upload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                originalImageName = file.name.split('.')[0]; // Extract name without extension
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                    originalImageSrc = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        img.onload = () => {
            const width = img.width;
            const height = img.height;
            imageDimensions.textContent = `Dimensions: ${width}px x ${height}px`;

            // Store original image data in full quality
            originalImgData = getImageDataForOriginal(img);

            const maxSize = 500;
            let widthAdjusted = img.width;
            let heightAdjusted = img.height;
            if (widthAdjusted > maxSize || heightAdjusted > maxSize) {
                const ratio = Math.min(maxSize / widthAdjusted, maxSize / heightAdjusted);
                widthAdjusted = widthAdjusted * ratio;
                heightAdjusted = heightAdjusted * ratio;
            }

            canvas.width = widthAdjusted;
            canvas.height = heightAdjusted;
            ctx.drawImage(img, 0, 0, widthAdjusted, heightAdjusted);

            // Detect dominant colors
            detectDominantColors();
        };

        function getImageDataForOriginal(image) {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = image.width;
            tempCanvas.height = image.height;
            tempCtx.drawImage(image, 0, 0);
            return tempCtx.getImageData(0, 0, image.width, image.height);
        }

        function detectDominantColors() {
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    // Reset color counts
    colorCounts = {};

    // Loop through each pixel and count color frequencies
    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const rgbColor = rgbToHex(r, g, b);

        if (colorCounts[rgbColor]) {
            colorCounts[rgbColor]++;
        } else {
            colorCounts[rgbColor] = 1;
        }
    }

    // Sort colors by frequency and take the top N most frequent colors (increased from 10 to 50)
    const sortedColors = Object.entries(colorCounts)
        .sort((a, b) => b[1] - a[1]) // Sort by frequency in descending order
        .slice(0, 50); // Increase the number of colors shown

    // Create color swatches for the most frequent colors
    displayColorSwatches(sortedColors);
}

// Optional: You can also implement clustering (like k-means) to group similar colors together
function clusterColors(colors, numClusters = 10) {
    // Implement k-means or a simpler color clustering approach
    // This will group similar colors together into clusters and return the most representative color of each cluster
    // (This could be done using a library or custom clustering code)
    return colors;
}

// Use clustering on the colors before displaying them
function displayColorSwatches(sortedColors) {
    const clusteredColors = clusterColors(sortedColors); // Optional: Cluster the colors before displaying

    colorPaletteContainer.innerHTML = '';  // Clear previous swatches

    clusteredColors.forEach(([color, frequency]) => {
        const colorSwatch = document.createElement('div');
        colorSwatch.classList.add('color-swatch');
        colorSwatch.style.backgroundColor = color;
        colorSwatch.addEventListener('click', () => {
            selectedColor = color;
            updateColorFields(selectedColor);
        });
        colorPaletteContainer.appendChild(colorSwatch);
    });
}

        // Convert RGB to Hex
        function rgbToHex(r, g, b) {
            return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase()}`;
        }

        // Convert Hex to RGB
        function hexToRgb(hex) {
            let bigint = parseInt(hex.slice(1), 16);
            return {
                r: (bigint >> 16) & 255,
                g: (bigint >> 8) & 255,
                b: bigint & 255
            };
        }

        function updateColorFields(color) {
            selectedColorDiv.style.backgroundColor = color; // Show the selected color
            hexInput.value = color; // Update the hex input field
            rgbInput.value = hexToRgbString(color); // Update the RGB input field
        }

        function hexToRgbString(hex) {
            const rgb = hexToRgb(hex);
            return `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
        }

        // Remove color from image
        function removeColor() {
            const targetColor = hexToRgb(selectedColor);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                if (isMatchingColor(data[i], data[i + 1], data[i + 2], targetColor)) {
                    data[i + 3] = 0; // Set alpha to 0 (transparent)
                }
            }
            ctx.putImageData(imageData, 0, 0);
        }

        function isMatchingColor(r, g, b, targetColor, tolerance = 50) {
            return Math.abs(r - targetColor.r) < tolerance &&
                   Math.abs(g - targetColor.g) < tolerance &&
                   Math.abs(b - targetColor.b) < tolerance;
        }

        function downloadImage() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            tempCtx.putImageData(originalImgData, 0, 0);
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;

            const targetColor = hexToRgb(selectedColor);
            for (let i = 0; i < data.length; i += 4) {
                if (isMatchingColor(data[i], data[i + 1], data[i + 2], targetColor)) {
                    data[i + 3] = 0;
                }
            }
            tempCtx.putImageData(imageData, 0, 0);

            const link = document.createElement('a');
            link.href = tempCanvas.toDataURL('image/png');
            link.download = `${originalImageName}_FYNRESH.png`; // Append "_FYNRESH" to the original name
            link.click();
        }

        eyeDropperBtn.addEventListener('click', () => {
            if ('EyeDropper' in window) {
                const eyeDropper = new EyeDropper();
                eyeDropper.open().then(result => {
                    selectedColor = result.sRGBHex; // Set the selected color from eye dropper
                    updateColorFields(selectedColor);
                }).catch(e => {
                    alert('Color picking failed: ' + e);
                });
            } else {
                // Fall back to color picker input for unsupported browsers (mobile)
                fallbackColorPicker.click();
            }
        });

        fallbackColorPicker.addEventListener('input', () => {
            selectedColor = fallbackColorPicker.value;
            updateColorFields(selectedColor);
        });

        hexInput.addEventListener('input', () => {
            const hexValue = hexInput.value.trim();
            if (/^#[0-9A-Fa-f]{6}$/.test(hexValue)) {
                selectedColor = hexValue;
                updateColorFields(selectedColor);
            }
        });

        rgbInput.addEventListener('input', () => {
            const rgbValue = rgbInput.value.trim();
            const rgbMatch = rgbValue.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
            if (rgbMatch) {
                const r = parseInt(rgbMatch[1], 10);
                const g = parseInt(rgbMatch[2], 10);
                const b = parseInt(rgbMatch[3], 10);
                selectedColor = rgbToHex(r, g, b);
                updateColorFields(selectedColor);
            }
        });
    </script>
</body>
</html>

